<project name="jacoco-core" default="build" basedir=".">

	<property file="build.properties" />
	<property name="version" value="0.6.5"/>
	<!-- option of major compiler -->
 	<property name="mutOp" value=":NONE"/>
        <!--<property name="mutator" value="-XMutator${mutOp}"/>-->
        <!--<property name="major" value="/home/hessahalkaoud/tools/major/bin/javac"/>-->
	

<!-- ======================= PATHS ====================================== --> 
        <path id="build.libs">
        <fileset dir="lib">
                <include name="*.jar"/>
        </fileset>
        </path>

<path id="jacoco.src">
    <pathelement location="${src.maven-plugin}" />
    <pathelement location="${src.agent}" />
    <pathelement location="${src.agent.rt}" />
    <pathelement location="${src.ant}" />
    <pathelement location="${src.core}" />
    <pathelement location="${src.report}" />
  </path>

<path id="jacoco.test">
    <pathelement location="${test.maven-plugin}" />
    <pathelement location="${test.agent}" />
    <pathelement location="${test.agent.rt}" />
    <pathelement location="${test.ant}" />
    <pathelement location="${test.core}" />
    <pathelement location="${test.report}" />
  </path>

<!-- ======================= Targets ==================================== -->

<!-- Target to build the whole project "default" -->
<target name="build" depends="clean, compile, compile.tests, test"/>

<!-- Target to clean up -->
    <target name="clean" description="Clean">
        <delete dir="${build}"/>
    </target>
   
<!-- Target to initialize build -->
    <target name="init">
        <mkdir dir="${build}"/>
    </target>

<!-- Target to compile the project -->
<!--<attribute name="classpath"/>-->
<!--classpath="@{classpath}"-->
 <macrodef name="jacoco_compilation">
    <attribute name="srcdir"/>
    <attribute name="destdir"/>
    <sequential>
      <mkdir dir="@{destdir}"/>
      <javac 
          srcdir="@{srcdir}"
          destdir="@{destdir}"
          debug="on"
          includeantruntime="true"
    	  fork="yes"
          executable="/home/hessahalkaoud/tools/major/bin/javac">
         <classpath  refid="build.libs"/>
	 <compilerarg value="-Xlint:unchecked" /> 
      	 <compilerarg value="-XMutator${mutOp}"/>
      </javac>
    </sequential>
  </macrodef>
    
    <target name="compile" depends="init" description="Compile">
        <!--<junit_compilation srcdir="${testsrc}" destdir="${testbin}" classpath="${hamcrestlib};${bin}"/>-->
	<jacoco_compilation srcdir="${src.maven-plugin}" destdir="${classes.maven-plugin}"/>
	<jacoco_compilation srcdir="${src.agent}" destdir="${classes.agent}"/>
	<jacoco_compilation srcdir="${src.agent.rt}" destdir="${classes.agent.rt}"/>
	<jacoco_compilation srcdir="${src.ant}" destdir="${classes.ant}"/>
	<jacoco_compilation srcdir="${src.core}" destdir="${classes.core}"/>
	<jacoco_compilation srcdir="${src.report}" destdir="${classes.report}"/>
    </target>

<!-- Target to compile the test suite -->
    <target name="compile.tests" depends="compile" description="Compile all tests">
        <jacoco_compilation srcdir="${test.maven-plugin}" destdir="${test-classes.maven-plugin}"/>
	<jacoco_compilation srcdir="${test.agent}" destdir="${test-classes.agent}"/>
	<jacoco_compilation srcdir="${test.agent.rt}" destdir="${test-classes.agent.rt}"/>
	<jacoco_compilation srcdir="${test.ant}" destdir="${test-classes.ant}"/>
	<jacoco_compilation srcdir="${test.core}" destdir="${test-classes.core}"/>
	<jacoco_compilation srcdir="${test.report}" destdir="${test-classes.report}"/>
    </target>

<!-- The adapted mutation test target -->
    <target name="mutation.test" description="Run mutation analysis for all unit test cases">
        <echo message="Running mutation analysis ..."/>
        <junit  printsummary="false" 
        	showoutput="false" 
        	mutationAnalysis="true"
                resultFile="results.csv" 
                killDetailsFile="killed.csv">
                
                <classpath path="build.core"/>
			
		<batchtest fork="no" skipNonTests="true" >
                  <fileset dir="${jacoco-maven-plugin.test.it}">
                    <include name="**/*.java"/>
                  </fileset>
		  <fileset dir="${org.jacoco.agent.test.src}">
                    <include name="**/*.java"/>
                  </fileset>
 		  <fileset dir="${org.jacoco.agent.rt.test.src}">
                    <include name="**/*.java"/>
                  </fileset>
		  <fileset dir="${org.jacoco.ant.test.src}">
                    <include name="**/*.java"/>
                  </fileset>
	  	  <fileset dir="${org.jacoco.core.test.src}">
                    <include name="**/*.java"/>
                  </fileset>
		  <fileset dir="${org.jacoco.report.test.src}">
                    <include name="**/*.java"/>
                  </fileset>
                </batchtest>
        </junit>
    </target>
<!-- The original test target -->
    <target name="test" depends="compile.tests" description="Run all unit test cases">
        <echo message="Running unit tests ..."/>
        <junit  printsummary="true" 
        	showoutput="true" 
                haltonfailure="false"
		fork="true">
            <classpath path="build.core"/>
			
		<batchtest fork="yes" skipNonTests="true" >
                  <fileset dir="${jacoco-maven-plugin.test.it}">
                    <include name="**/*.java"/>
                  </fileset>
		  <fileset dir="${org.jacoco.agent.test.src}">
                    <include name="**/*.java"/>
                  </fileset>
 		  <fileset dir="${org.jacoco.agent.rt.test.src}">
                    <include name="**/*.java"/>
                  </fileset>
		  <fileset dir="${org.jacoco.ant.test.src}">
                    <include name="**/*.java"/>
                  </fileset>
	  	  <fileset dir="${org.jacoco.core.test.src}">
                    <include name="**/*.java"/>
                  </fileset>
		  <fileset dir="${org.jacoco.report.test.src}">
                    <include name="**/*.java"/>
                  </fileset>
                </batchtest>
        </junit>
    </target>
</project>
