
<!--
    Note: Use of <artifact:dependencies/> requires maven-ant-tasks-2.1.3.jar in $ANT_HOME/lib
          Download it from http://maven.apache.org/ant-tasks/download.html or copy it from the JBehave bin distribution
  -->
<project name="jbehave" default="build" xmlns:artifact="antlib:org.apache.maven.artifact.ant">

	<property name="src.dir" value="target/src"/>
    <property name="jbehave.version"  value="3.9-SNAPSHOT"/>
	
	<target name="clean">
		<delete dir="target" />
	</target>

	<target name="setup">
	    <artifact:dependencies filesetId="dependency.fileset" useScope="test">
	        <dependency groupId="org.jbehave" artifactId="jbehave-ant" version="${jbehave.version}"/>	    	
	        <dependency groupId="org.jbehave" artifactId="jbehave-core" version="${jbehave.version}" classifier="resources" type="zip"/>           
            <dependency groupId="org.jbehave.site" artifactId="jbehave-site-resources" version="3.1.1" type="zip"/>           
	    </artifact:dependencies>

		<mkdir dir="target" />
		<mkdir dir="target/classes" />
		<mkdir dir="target/lib" />
		<copy todir="target/lib">
			<fileset refid="dependency.fileset" />
			<mapper type="flatten" />
		</copy>
		<copy todir="${src.dir}">
			<fileset dir="../core/src/main/java">		
		    </fileset>
		</copy>
		<copy todir="target/classes">
			<fileset dir="${src.dir}">
				<include name="**/*.story" />
				<include name="**/*.properties" />
				<include name="**/*.xml" />
			</fileset>
		</copy>

		<path id="story.classpath">
			<fileset dir="target/lib" includes="**/*.jar" />
			<pathelement location="target/classes" />
		</path>
		<classloader classpathref="story.classpath" />

		<pathconvert targetos="unix" property="story.classpath.unix" refid="story.classpath">
		</pathconvert>
		<echo>Using classpath: ${story.classpath.unix}</echo>

	</target>

	<target name="compile" depends="setup">
		<javac srcdir="${src.dir}" destdir="target/classes" debug="on" debuglevel="lines,source" includes="**/*.java,**/*.xml">
			<classpath refid="story.classpath" />
		</javac>
	</target>

	<target name="reports-resources" depends="setup">
		<unzip src="${org.jbehave:jbehave-core:zip:resources}" dest="${basedir}/target/jbehave/view/" />
		<unzip src="${org.jbehave.site:jbehave-site-resources:zip}" dest="${basedir}/target/jbehave/view/" />
	</target>

	<target name="run-stories-as-embeddables" depends="compile, reports-resources">
		<taskdef name="runStoriesAsEmbeddables" classname="org.jbehave.ant.RunStoriesAsEmbeddables" classpathref="story.classpath" />
		<runStoriesAsEmbeddables sourceDirectory="${src.dir}" includes="**/stories/*.java" excludes="**/examples*" batch="false" ignoreFailureInStories="true" ignoreFailureInView="true" generateViewAfterStories="true" 
			systemproperties="java.awt.headless=true,project.dir=${basedir}" />
	</target>

	<target name="run-stories-as-paths" depends="compile, reports-resources">
		<taskdef name="runStoriesAsPaths" classname="org.jbehave.ant.RunStoriesAsPaths" classpathref="story.classpath" />
		<runStoriesAsPaths sourceDirectory="${src.dir}" includes="**/stories/*.story" excludes="**/examples*" batch="false" ignoreFailureInStories="true" ignoreFailureInView="true" generateViewAfterStories="true" />
	</target>

	<target name="stepdoc" depends="compile">
		<taskdef name="reportStepdocs" classname="org.jbehave.ant.ReportStepdocs" classpathref="story.classpath" />
		<reportStepdocs embedderClass="org.jbehave.examples.core.CoreEmbedder" />
	</target>

	<target name="build" depends="run-stories-as-embeddables,run-stories-as-paths,stepdoc" />

</project>